---
import Gatekeeper from '@components/ShowForInstructor.tsx';
import Course from '@layouts/Course.astro';
import type { GetStaticPaths } from 'astro';
import { getCollection } from 'astro:content';
import { formatWeekString, getAnchorTarget, getResourceHref, resourceSorter, SYMBOLS } from 'src/global';

export const getStaticPaths = (async () => {
  // Get all classes from src/content/classes/
  const classes = await getCollection('classes')

  return classes.map(_class => {
    return {
      params: {
        class: _class.id?.split('/').at(0),
        year: _class.id?.split('/').at(1),
      },
      props: {
        class: _class,
      },
    }
  })
}) satisfies GetStaticPaths

const { props: { class: _class }, url: { pathname } } = Astro;

// Remove /instructor from pathname so links are relative to the class homepage
const _pathname = pathname.replace(/\/instructor$/, '')

// Import examples for each class
const exampleImports = import.meta.glob('../../../../../public/2024/fall/computer-science/examples/*.py', { eager: true });
const examples = Object.keys(exampleImports).map(url => url.replace(/^.+\/public/, ''));

// Get all resources for the class
let articles = await getCollection('articles')
let assignments = await getCollection('assignments')
let slides = await getCollection('slides')
let videos = await getCollection('videos')
let games = await getCollection('games')
const computerScienceArticles = articles.flatMap(({ id, collection, data }) => data.filter(article => article.class === _class.id).map(resource => ({ id, collection, data: resource })))
const computerScienceAssignments = assignments.filter(assignment => assignment.data.class === _class.id).flat()
const computerScienceSlides = slides.filter(slide => slide.data.class === _class.id).flat()
const computerScienceVideos = videos.flatMap(({ id, collection, data }) => data.filter(video => video.class === _class.id).map(resource => ({ id, collection, data: resource })))
const computerScienceGames = games.flatMap(({ id, collection, data }) => data.filter(game => game.class === _class.id).map(resource => ({ id, collection, data: resource })))
const allResources = [...computerScienceArticles, ...computerScienceAssignments, ...computerScienceSlides, ...computerScienceVideos, ...computerScienceGames]
allResources.sort((a, b) => a.data.date.getTime() - b.data.date.getTime());

// Group resources by assignment week
let resourcesByDate = allResources.reduce(
  (acc, resource) => {
    const date = resource.data.date.toISOString().slice(0, 10)
    if (!acc[date]) {
      acc[date] = []
    }
    acc[date].push(resource)
    return acc
  },
  {} as Record<string, (typeof allResources)[number][]>,
)

// Include cumulative minutes for each week
let resourcesWithCumulativeMinutes = Object.entries(resourcesByDate).map(([date, resources], index) => {
  const minutes = resources.reduce((a, b) => a + b.data.time, 0)
  return {
    date,
    resources,
    minutes,
    week: index + 1,
  }
})


// Calculated with the assumption that a student needs 75 hours / 16 weeks = 4.6875 hours per week
const IDEAL_WEEKLY_MINUTES = 280;
const WEEKLY_MINUTES_IN_CLASS = 110;
const IDEAL_WEEKLY_RESOURCE_MINUTES = IDEAL_WEEKLY_MINUTES - WEEKLY_MINUTES_IN_CLASS;

// Calculate total minutes
let totalMinutes = resourcesWithCumulativeMinutes.reduce((a, b) => a + b.minutes, 0);
totalMinutes += WEEKLY_MINUTES_IN_CLASS * resourcesWithCumulativeMinutes.length;

const getEstimateStatus = (minutes: number) => {
  if (minutes < IDEAL_WEEKLY_RESOURCE_MINUTES - 60) return 'bad';
  else if (minutes < IDEAL_WEEKLY_RESOURCE_MINUTES - 30) return 'good';
  else if (minutes < IDEAL_WEEKLY_RESOURCE_MINUTES + 45) return 'ideal';
  else if (minutes < IDEAL_WEEKLY_RESOURCE_MINUTES + 90) return 'good';
  else return 'bad';
}

const STATUS_TO_STYLE = {
  ideal: 'background:#6d68;color:#000',
  good: 'background:#fd48;color:#000',
  bad: 'background:#f668;color:#000',
}
---

<Course class={_class.id}>
  <p>
    &larr; <a href={`/${_class.id}`}>Course Homepage</a>
  </p>
  <h1>Instructor Page</h1>
  <p>Contains information that <strong>should only be viewed by the instructor</strong>.</p>
  <main>
    <Gatekeeper client:load>
      <div>
        <h3>Examples</h3>
        <ul>
          {examples.map(url => (
            <li>
              <a href={url}>{url.slice(url.lastIndexOf('/') + 1)}</a>
            </li>
          ))}
        </ul>
        <h2>All Weekly Resources</h2>
        <table style="width:100%;">
          <thead>
            <tr>
              <th>Week</th>
              <th>Topic(s)</th>
              <th>Resources</th>
              <th>Time Estimate</th>
            </tr>
          </thead>
          <tbody>
            {
              resourcesWithCumulativeMinutes.map(({ date, resources, minutes, week }, index) => (
                <tr>
                  <td>
                    <div>
                      <strong>Week {week}</strong>
                    </div>
                    <div>
                      <em>{formatWeekString(date, { duration: index === 0 ? (1000 * 60 * 60 * 24 * 7) : undefined })}</em>
                    </div>
                  </td>
                  <td>
                    <ul>
                      {
                        Array.from(new Set(resources.flatMap(resource => resource.data.topics))).map(topic => (
                          <li>{topic}</li>
                        ))
                      }
                    </ul>
                  </td>
                  <td>
                    <ul class="emoji">
                      {
                        resources.toSorted(resourceSorter).map(resource => (
                          <li>
                            {SYMBOLS[resource.data.type as keyof typeof SYMBOLS]}{' '}
                            <a href={getResourceHref(resource, _pathname)} target={getAnchorTarget(getResourceHref(resource, pathname))}>
                              {resource.data.title}
                            </a>
                          </li>
                        ))
                      }
                    </ul>
                  </td>
                  <td>
                    <div style={`text-align:center;border-radius:2px;padding:0 4px;${STATUS_TO_STYLE[getEstimateStatus(minutes)]}`}>
                      {minutes >= 60 ? <span>{Math.floor(minutes / 60)} hr</span> : ''}
                      <span>{minutes % 60} min</span>
                    </div>
                  </td>
                </tr>
              ))
            }
            <tr>
              <td>
                <strong>Cumulative</strong>
              </td>
              <td>N/A</td>
              <td>N/A</td>
              <td>{Math.floor(totalMinutes / 60)} hr {Math.floor(totalMinutes % 60)} min</td>
            </tr>
          </tbody>
        </table>
      </div>
    </Gatekeeper>
  </main>
</Course>