---
import Course from '@layouts/Course.astro';
import type { GetStaticPaths } from 'astro';
import { getCollection } from 'astro:content';
import { DateTime } from 'luxon';
import { assignedBeforeNow, capitalizeString, formatWeekString, isHrefExternal, SYMBOLS } from 'src/global';

export const getStaticPaths = (async () => {
  // Get all classes from src/content/classes/
  const classes = await getCollection('classes')
  
  // Get all articles, assignments, slides, videos, and games from src/content/
  let articles = await getCollection('articles')
  let assignments = await getCollection('assignments')
  let slides = await getCollection('slides')
  let videos = await getCollection('videos')
  let games = await getCollection('games')

  // Combine all resources into a single array
  const computerScienceId = 'computer-science'
  const computerScienceArticles = articles.filter(article => article.id.startsWith(computerScienceId)).flatMap(({ id, collection, data }) => data.map(resource => ({ id, collection, data: resource })))
  const computerScienceAssignments = assignments.filter(assignment => assignment.id.startsWith(computerScienceId)).flat()
  const computerScienceSlides = slides.filter(slide => slide.id.startsWith(computerScienceId)).flat()
  const computerScienceVideos = videos.filter(video => video.id.startsWith(computerScienceId)).flatMap(({ id, collection, data }) => data.map(resource => ({ id, collection, data: resource })))
  const computerScienceGames = games.filter(game => game.id.startsWith(computerScienceId)).flatMap(({ id, collection, data }) => data.map(resource => ({ id, collection, data: resource })))
  const allResources = [...computerScienceArticles, ...computerScienceAssignments, ...computerScienceSlides, ...computerScienceVideos, ...computerScienceGames]

  // Filter classes to only computer-science classes
  const computerScienceClasses = classes.filter(_class => _class.id.startsWith(computerScienceId))

  // Group resources by class slug
  return computerScienceClasses.map(_class => {
    // Filter resources that match this class's slug
    const classResources = allResources.filter(resource => resource.data.class === _class.id)

    // Extract year from class ID (e.g., "computer-science/2024" -> "2024")
    const year = _class.id.split('/').at(-1) || _class.data.startDate.getFullYear().toString()

    return {
      params: {
        year,
      },
      props: {
        class: _class,
        resources: classResources.toSorted((a, b) => a.data.date.getTime() - b.data.date.getTime()),
      },
    }
  })
}) satisfies GetStaticPaths

const {
  props: { class: _class, resources },
  url: { pathname },
  params: { year },
} = Astro

// Create an array of weeks, each as { startDate, endDate, resources }
const classStartDate = DateTime.fromJSDate(_class.data.startDate, { zone: 'America/Los_Angeles' });
const classEndDate = DateTime.fromJSDate(_class.data.endDate, { zone: 'America/Los_Angeles' });
const diffWeeks = Math.ceil(classEndDate.diff(classStartDate, 'weeks').weeks);
let resourcesByWeek: {
  startDate: DateTime;
  endDate: DateTime;
  resources: typeof resources;
}[] = [];
for (let week = 0; week < diffWeeks; week++) {
  const weekStart = classStartDate.plus({ weeks: week });
  const weekEnd = weekStart.endOf('week');
  const weekResources = resources.filter(r => {
    const d = DateTime.fromJSDate(r.data.date, { zone: 'America/Los_Angeles' });
    return d >= weekStart && d <= weekEnd;
  });
  resourcesByWeek.push({
    startDate: weekStart,
    endDate: weekEnd,
    resources: weekResources,
  });
}

const getResourceHref = (resource: (typeof resources)[number]) => {
  if (!resource.data.href) {
    const slug = resource.id.split('/').at(1)?.split('.').at(0)
    if (slug) {
      return `${pathname}/${resource.collection}/${slug}`
    }
  }
  return resource.data.href
}

const getAnchorTarget = (href: string | undefined) => {
  // external links opened in new tab
  return href && isHrefExternal(href) ? '_blank' : undefined
}
---

<Course class={`computer-science/${year}`}>
  <blockquote>
    <p>There are only two hard things in Computer Science: cache invalidation and naming things.</p>
    <p><cite>Phil Karlton</cite></p>
  </blockquote>
  <h2><span class="secret-link">Course</span> Resources</h2>
  <p>These resources will be used throughout the entirety of the course.</p>
  <table>
    <tbody>
      <tr>
        <td>
          <a href="mailto:rylanschubkegel@gmail.com" target="_blank">rylanschubkegel@gmail.com</a>
          <br /><a href="tel:+13608401401">360-840-1401</a>
        </td>
        <td> Instructor contact information. </td>
      </tr>
      <tr>
        <td>
          <a href={`${pathname}/syllabus`}>Course Syllabus</a>
        </td>
        <td> Includes an overview of the topics covered, grading criteria, and participation expectations. </td>
      </tr>
      <tr>
        <td>
          <a href="https://replit.com/" target="_blank">Replit</a>
        </td>
        <td>
          Online <abbr title="integrated development environment">IDE</abbr> used for coding; can be accessed from any computer via Google account or username/password.
        </td>
      </tr>
      <tr>
        <td>
          <a href="https://code.visualstudio.com/" target="_blank">VS Code</a>
        </td>
        <td>
          <abbr title="integrated development environment">IDE</abbr> used for coding; runs locally as a desktop application. Requires <a href="https://www.python.org/" target="_blank">Python</a> interpreter to be installed on your machine.
        </td>
      </tr>
      <tr>
        <td>
          <a href="https://www.python.org/" target="_blank">Python</a>
        </td>
        <td> Python interpreter that runs `.py` files on your local machine. </td>
      </tr>
      <tr>
        <td>
          <a href="https://www.pygame.org/docs/" target="_blank">Pygame</a>
        </td>
        <td> Documentation for the Pygame library which is used for making games in Python. </td>
      </tr>
    </tbody>
  </table>
  <h2>Weekly Resources</h2>
  <details>
    <summary>Legend</summary>
    <ul class="emoji">
      {
        Object.entries(SYMBOLS).map(([title, emoji]) => (
          <li>
            {emoji} {capitalizeString(title)}
          </li>
        ))
      }
    </ul>
  </details>
  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th hidden>Topic(s)</th>
        <th>Resources</th>
      </tr>
    </thead>
    <tbody>
      {
        resourcesByWeek.map(({ startDate, resources }, index) => (
          <tr style={`display: ${assignedBeforeNow(startDate.toISO()!) ? 'table-row' : 'none'};`}>
            <td>
              <strong>Week {index + 1}</strong>
              <br>
              <em>{formatWeekString(startDate.toISO()!)}</em>
            </td>
            <td hidden>
              <ul>
                {resources
                  .flatMap(resource => resource.data.topics)
                  .map(topic => (
                    <li>{topic}</li>
                  ))}
              </ul>
              {resources.flatMap(resource => resource.data.topics).length === 0 && <p>N/A</p>}
            </td>
            <td>
              <ul class="emoji">
                {resources.map(resource => (
                  <li>
                    {SYMBOLS[resource.data.type as keyof typeof SYMBOLS]}{' '}
                    <a href={getResourceHref(resource)} target={getAnchorTarget(resource.data.href)}>
                      {resource.data.title}
                    </a>
                  </li>
                ))}
              </ul>
            </td>
          </tr>
        ))
      }
    </tbody>
  </table>
</Course>

<script>
  let clicks = 0
  const element = document.querySelector<HTMLElement>('.secret-link')
  if (element) {
    element.addEventListener('click', () => {
      clicks += 1
      if (clicks === 3) {
        let href = window.location.href
        if (href.at(-1) === '/') href = href.slice(0, -1)
        window.location.href = href + '/instructor'
      }
    })
  }
</script>
